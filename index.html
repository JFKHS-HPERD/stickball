<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stickball Scorekeeping App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
            color: #212529;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
        }

        .section {
            background-color: #ffffff;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #212529;
        }

        .game-info {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .info-item {
            padding: 12px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #007bff;
        }

        .info-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .info-value {
            font-size: 16px;
            font-weight: 600;
            color: #212529;
        }

        .current-batter-display {
            padding: 12px;
            background-color: #e7f3ff;
            border-left: 3px solid #007bff;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .current-batter-label {
            font-size: 12px;
            color: #0056b3;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .current-batter-name {
            font-size: 18px;
            font-weight: 600;
            color: #007bff;
        }

        .counters-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .strike-counter-display {
            padding: 12px;
            background-color: #fff3cd;
            border-left: 3px solid #ffc107;
            border-radius: 6px;
        }

        .strike-counter-label {
            font-size: 12px;
            color: #856404;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .strike-counter-value {
            font-size: 18px;
            font-weight: 600;
            color: #ffc107;
        }

        .toss-counter-display {
            padding: 12px;
            background-color: #e8f5e9;
            border-left: 3px solid #28a745;
            border-radius: 6px;
        }

        .toss-counter-label {
            font-size: 12px;
            color: #2e7d32;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .toss-counter-value {
            font-size: 18px;
            font-weight: 600;
            color: #28a745;
        }

        .button-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .button-group.full {
            grid-template-columns: 1fr;
        }

        .button-group.triple {
            grid-template-columns: repeat(3, 1fr);
        }

        button {
            padding: 12px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .btn-success {
            background-color: #28a745;
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background-color: #e0a800;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-info {
            background-color: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background-color: #138496;
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 12px;
        }

        .roster-section {
            margin-bottom: 20px;
        }

        .roster-title {
            font-size: 14px;
            font-weight: 600;
            color: #212529;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .player-input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .player-input-group input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 14px;
        }

        .player-list {
            display: grid;
            gap: 6px;
            margin-bottom: 12px;
        }

        .player-item {
            padding: 8px 12px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }

        .player-item.inactive {
            opacity: 0.6;
        }

        .player-actions {
            display: flex;
            gap: 4px;
        }

        .btn-toggle {
            padding: 4px 8px;
            font-size: 11px;
            background-color: #e9ecef;
            color: #495057;
        }

        .btn-toggle.active {
            background-color: #28a745;
            color: white;
        }

        .btn-remove {
            padding: 4px 8px;
            font-size: 11px;
            background-color: #e9ecef;
            color: #495057;
        }

        .btn-remove:hover {
            background-color: #dc3545;
            color: white;
        }

        .timer-display {
            font-size: 32px;
            font-weight: 600;
            color: #007bff;
            text-align: center;
            padding: 16px;
            background-color: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 12px;
        }

        .timer-controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-bottom: 16px;
        }

        .game-log {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px;
            background-color: #fafbfc;
        }

        .log-entry {
            padding: 8px;
            margin-bottom: 8px;
            background-color: #ffffff;
            border-left: 3px solid #007bff;
            border-radius: 4px;
            font-size: 13px;
            line-height: 1.5;
        }

        .log-entry.auto-conversion {
            border-left-color: #ffc107;
            background-color: #fffbf0;
        }

        .log-timestamp {
            color: #6c757d;
            font-size: 11px;
        }

        .log-batter {
            font-weight: 600;
            color: #0056b3;
        }

        .log-action {
            color: #212529;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: white;
            border-radius: 8px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #212529;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .player-selector {
            display: grid;
            gap: 8px;
        }

        .player-option {
            padding: 12px;
            background-color: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .player-option:hover {
            background-color: #e7f3ff;
            border-color: #007bff;
        }

        .player-option.selected {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }

        .modal-footer {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .step-indicator {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 12px;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
            }

            .game-info {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .game-info {
                grid-template-columns: 1fr;
            }

            .button-group {
                grid-template-columns: 1fr;
            }

            .counters-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Left Section: Game Control -->
        <div class="section">
            <h2 class="section-title">Game Control</h2>

            <div class="game-info">
                <div class="info-item">
                    <div class="info-label">Inning</div>
                    <div class="info-value">
                        <span id="inningNumber">1</span> - <span id="inningPhase">Top</span>
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label">Outs</div>
                    <div class="info-value" id="outsDisplay">0</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Team 1 Score</div>
                    <div class="info-value" id="team1Score">0</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Team 2 Score</div>
                    <div class="info-value" id="team2Score">0</div>
                </div>
            </div>

            <div class="current-batter-display" id="batterDisplay" style="display: none;">
                <div class="current-batter-label">Current Batter</div>
                <div class="current-batter-name" id="currentBatterName">None Selected</div>
            </div>

            <div class="counters-container" id="countersContainer" style="display: none;">
                <div class="toss-counter-display">
                    <div class="toss-counter-label">Tosses</div>
                    <div class="toss-counter-value" id="tossCounterValue">0</div>
                </div>
                <div class="strike-counter-display">
                    <div class="strike-counter-label">Strikes</div>
                    <div class="strike-counter-value" id="strikeCounterValue">0</div>
                </div>
            </div>

            <div class="button-group full">
                <button class="btn-primary" onclick="openBatterModal()">Select Batter</button>
            </div>

            <div class="roster-title">At-Bat Actions</div>
           <div class="button-group">
    <button class="btn-info" onclick="attemptToss()">Toss</button>
    <button class="btn-secondary" onclick="resetToss()">Reset Toss</button>
    <button class="btn-warning" onclick="attemptStrikeFoul()">Strike (Foul)</button>
    <button class="btn-warning" onclick="attemptStrikeSwing()">Strike (Swing)</button>
</div>

<div class="button-group full">
    <button class="btn-success" onclick="attemptAddPoint()">Add Point</button>
</div>

            <div class="button-group triple">
                <button class="btn-success" onclick="attemptHomeRun()">Home Run</button>
                <button class="btn-info" onclick="attemptHitBase1()">Hit to Base 1</button>
                <button class="btn-info" onclick="attemptHitBase2()">Hit to Base 2</button>
            </div>

            <div class="button-group full">
                <button class="btn-danger" onclick="attemptPopFlyCatch()">Pop Fly Catch</button>
            </div>

            <div class="button-group full">
                <button class="btn-danger" onclick="attemptTaggedOut()">Tagged Out</button>
            </div>

            <div class="roster-title" style="margin-top: 20px;">Game Management</div>
            <div class="button-group">
                <button class="btn-secondary" onclick="nextInning()">Next Inning</button>
                <button class="btn-secondary" onclick="switchTeams()">Switch Teams</button>
                <button class="btn-danger" onclick="resetGame()">Reset Game</button>
            </div>

            <div class="timer-display" id="timerDisplay">00:00</div>
            <div class="timer-controls">
                <button class="btn-primary btn-small" onclick="startTimer()">Start</button>
                <button class="btn-warning btn-small" onclick="pauseTimer()">Pause</button>
                <button class="btn-secondary btn-small" onclick="resetTimer()">Reset</button>
            </div>

            <div class="button-group full">
                <button class="btn-primary" onclick="exportGameDataCSV()">Export to CSV</button>
            </div>
        </div>

        <!-- Right Section: Roster & Game Log -->
        <div class="section">
            <h2 class="section-title">Roster Management</h2>

            <div class="roster-section">
                <div class="roster-title">Active Team</div>
                <div id="activeTeamDisplay" style="font-size: 16px; font-weight: 600; color: #007bff; margin-bottom: 12px;">Team 1</div>

                <div class="player-input-group">
                    <input type="text" id="newPlayerInput" placeholder="Enter player name" onkeypress="if(event.key === 'Enter') addPlayer()">
                    <button class="btn-primary btn-small" onclick="addPlayer()">Add</button>
                </div>

                <div class="player-list" id="team1Roster"></div>
            </div>

            <h2 class="section-title" style="margin-top: 24px;">Game Log</h2>
            <div class="game-log" id="gameLog"></div>

            <div style="margin-top: 12px;">
                <button class="btn-secondary" onclick="clearGameLog()" style="width: 100%;">Clear Log</button>
            </div>
        </div>
    </div>

    <!-- Select Batter Modal -->
    <div id="batterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Select Current Batter</div>
            <div class="modal-body">
                <div class="step-indicator">Choose a player from the active team roster:</div>
                <div class="player-selector" id="batterPlayerSelector"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeBatterModal()">Cancel</button>
                <button class="btn-primary" onclick="confirmBatterSelection()" id="confirmBatterBtn" disabled>Confirm</button>
            </div>
        </div>
    </div>

    <!-- Scorer Modal -->
    <div id="scorerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Who Scored?</div>
            <div class="modal-body">
                <div class="step-indicator">Select the player who scored:</div>
                <div class="player-selector" id="scorerPlayerSelector"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeScorerModal()">Cancel</button>
                <button class="btn-primary" onclick="confirmScorerSelection()" id="confirmScorerBtn" disabled>Confirm</button>
            </div>
        </div>
    </div>

    <!-- Tagged Out Modal -->
    <div id="taggedOutModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Tag Out</div>
            <div class="modal-body" id="taggedOutModalBody"></div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeTaggedOutModal()">Cancel</button>
                <button class="btn-primary" onclick="confirmTaggedOut()" id="confirmTaggedOutBtn" disabled>Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // State Management
        const gameState = {
            inning: 1,
            inningPhase: 'Top',
            outs: 0,
            team1Score: 0,
            team2Score: 0,
            currentTeam: 1,
            timerSeconds: 0,
            timerRunning: false,
            selectedBatterIndex: null,
            tosses: 0,
            strikes: 0,
            gameLog: []
        };

        const rosters = {
            team1: [],
            team2: []
        };

        const activeStatus = {
            team1: [],
            team2: []
        };

        let timerInterval = null;
        let selectedScorerIndex = null;
        let selectedTaggedOutPlayerIndex = null;
        let selectedTaggedOutBase = null;

        // Initialize
        function initializeApp() {
            updateUI();
            renderRoster();
        }

        // Add Player to Roster
        function addPlayer() {
            const input = document.getElementById('newPlayerInput');
            const playerName = input.value.trim();

            if (playerName) {
                const team = gameState.currentTeam === 1 ? 'team1' : 'team2';
                rosters[team].push(playerName);
                activeStatus[team].push(true);
                input.value = '';
                renderRoster();
                addGameLog(`Player "${playerName}" added to Team ${gameState.currentTeam}`);
            }
        }

        // Render Roster
        function renderRoster() {
            const team = gameState.currentTeam === 1 ? 'team1' : 'team2';
            const rosterElement = document.getElementById('team1Roster');
            rosterElement.innerHTML = '';

            rosters[team].forEach((player, index) => {
                const isActive = activeStatus[team][index];
                const playerItem = document.createElement('div');
                playerItem.className = `player-item ${!isActive ? 'inactive' : ''}`;
                playerItem.innerHTML = `
                    <span>${player}</span>
                    <div class="player-actions">
                        <button class="btn-toggle ${isActive ? 'active' : ''}" onclick="togglePlayerActive(${index})">${isActive ? 'Active' : 'Inactive'}</button>
                        <button class="btn-remove" onclick="removePlayer(${index})">Remove</button>
                    </div>
                `;
                rosterElement.appendChild(playerItem);
            });
        }

        // Toggle Player Active Status
        function togglePlayerActive(index) {
            const team = gameState.currentTeam === 1 ? 'team1' : 'team2';
            activeStatus[team][index] = !activeStatus[team][index];
            renderRoster();
        }

        // Remove Player
        function removePlayer(index) {
            const team = gameState.currentTeam === 1 ? 'team1' : 'team2';
            rosters[team].splice(index, 1);
            activeStatus[team].splice(index, 1);
            renderRoster();
        }

        // Batter Modal Functions
        function openBatterModal() {
            const team = gameState.currentTeam === 1 ? 'team1' : 'team2';
            const selector = document.getElementById('batterPlayerSelector');
            selector.innerHTML = '';

            rosters[team].forEach((player, index) => {
                if (activeStatus[team][index]) {
                    const option = document.createElement('div');
                    option.className = `player-option ${gameState.selectedBatterIndex === index ? 'selected' : ''}`;
                    option.textContent = player;
                    option.onclick = () => selectBatterOption(index);
                    selector.appendChild(option);
                }
            });

            document.getElementById('batterModal').classList.add('active');
            updateConfirmBatterBtn();
        }

        function selectBatterOption(index) {
            gameState.selectedBatterIndex = index;
            openBatterModal();
        }

        function confirmBatterSelection() {
            if (gameState.selectedBatterIndex !== null) {
                const team = gameState.currentTeam === 1 ? 'team1' : 'team2';
                const batterName = rosters[team][gameState.selectedBatterIndex];
                resetStrikesAndTosses();
                addGameLog(`${batterName} is now batting`);
                updateUI();
                closeBatterModal();
            }
        }

        function closeBatterModal() {
            document.getElementById('batterModal').classList.remove('active');
        }

        function updateConfirmBatterBtn() {
            document.getElementById('confirmBatterBtn').disabled = gameState.selectedBatterIndex === null;
        }

        // Reset Strikes and Tosses
        function resetStrikesAndTosses() {
            gameState.strikes = 0;
            gameState.tosses = 0;
        }

        // Toss Function with Automatic Conversion
        function attemptToss() {
            if (gameState.selectedBatterIndex === null) {
                alert('Please select a batter first!');
                openBatterModal();
                return;
            }

            gameState.tosses++;
            const team = gameState.currentTeam === 1 ? 'team1' : 'team2';
            const batterName = rosters[team][gameState.selectedBatterIndex];
            addGameLog(`${batterName} - Toss #${gameState.tosses}`);

            // Check if tosses reached 4 for automatic conversion
            if (gameState.tosses === 4) {
                gameState.tosses = 0;
                gameState.strikes++;
                addGameLog(`${batterName} - Automatic Strike from 4 tosses! (${gameState.strikes}/3)`, true);

            
                // Check if strikes reached 3 for automatic out
                if (gameState.strikes >= 3) {
                    triggerAutoOut();
                } else {
                    updateUI();
                }
            } else {
                updateUI();
            }
        }

        // Strike Functions
        function attemptStrikeFoul() {
            if (gameState.selectedBatterIndex === null) {
                alert('Please select a batter first!');
                openBatterModal();
                return;
            }

            gameState.strikes++;
            const team = gameState.currentTeam === 1 ? 'team1' : 'team2';
            const batterName = rosters[team][gameState.selectedBatterIndex];
            addGameLog(`${batterName} - Strike (Foul) ${gameState.strikes}/3`);

            if (gameState.strikes >= 3) {
                triggerAutoOut();
            } else {
                updateUI();
            }
        }

        function attemptStrikeSwing() {
            if (gameState.selectedBatterIndex === null) {
                alert('Please select a batter first!');
                openBatterModal();
                return;
            }

            gameState.strikes++;
            const team = gameState.currentTeam === 1 ? 'team1' : 'team2';
            const batterName = rosters[team][gameState.selectedBatterIndex];
            addGameLog(`${batterName} - Strike (Swing) ${gameState.strikes}/3`);

            if (gameState.strikes >= 3) {
                triggerAutoOut();
            } else {
                updateUI();
            }
        }

        // Reset Toss Function
function resetToss() {
    if (gameState.selectedBatterIndex === null) {
        alert('Please select a batter first!');
        openBatterModal();
        return;
    }

    const team = gameState.currentTeam === 1 ? 'team1' : 'team2';
    const batterName = rosters[team][gameState.selectedBatterIndex];
    const previousTosses = gameState.tosses;
    gameState.tosses = 0;
    addGameLog(`${batterName} - Toss count reset (was ${previousTosses})`);
    updateUI();
}
        
        // Auto Out on 3 Strikes
        function triggerAutoOut() {
            const team = gameState.currentTeam === 1 ? 'team1' : 'team2';
            const batterName = rosters[team][gameState.selectedBatterIndex];
            gameState.outs++;
            addGameLog(`${batterName} - OUT on strikes!`);

            if (gameState.outs >= 3) {
                gameState.outs = 0;
                switchInning();
            } else {
                resetStrikesAndTosses();
                gameState.selectedBatterIndex = null;
                updateUI();
            }
        }

        // Add Point Function
        function attemptAddPoint() {
            if (gameState.selectedBatterIndex === null) {
                alert('Please select a batter first!');
                openBatterModal();
                return;
            }

            const team = gameState.currentTeam === 1 ? 'team1' : 'team2';
            const selector = document.getElementById('scorerPlayerSelector');
            selector.innerHTML = '';

            rosters[team].forEach((player, index) => {
                if (activeStatus[team][index]) {
                    const option = document.createElement('div');
                    option.className = 'player-option';
                    option.textContent = player;
                    option.onclick = () => selectScorerOption(index);
                    selector.appendChild(option);
                }
            });

            selectedScorerIndex = null;
            document.getElementById('scorerModal').classList.add('active');
            updateConfirmScorerBtn();
        }

        function selectScorerOption(index) {
            selectedScorerIndex = index;
            document.querySelectorAll('#scorerPlayerSelector .player-option').forEach((el, i) => {
                el.classList.toggle('selected', i === index);
            });
            updateConfirmScorerBtn();
        }

        function confirmScorerSelection() {
            if (selectedScorerIndex !== null) {
                const team = gameState.currentTeam === 1 ? 'team1' : 'team2';
                const scorerName = rosters[team][selectedScorerIndex];
                const batterName = rosters[team][gameState.selectedBatterIndex];

                if (gameState.currentTeam === 1) {
                    gameState.team1Score++;
                } else {
                    gameState.team2Score++;
                }

                addGameLog(`${batterName} hit - ${scorerName} scored (Team ${gameState.currentTeam})`);
                updateUI();
                closeScorerModal();
            }
        }

        function closeScorerModal() {
            document.getElementById('scorerModal').classList.remove('active');
        }

        function updateConfirmScorerBtn() {
            document.getElementById('confirmScorerBtn').disabled = selectedScorerIndex === null;
        }

        // Home Run Function
        function attemptHomeRun() {
            if (gameState.selectedBatterIndex === null) {
                alert('Please select a batter first!');
                openBatterModal();
                return;
            }

            const team = gameState.currentTeam === 1 ? 'team1' : 'team2';
            const batterName = rosters[team][gameState.selectedBatterIndex];

            if (gameState.currentTeam === 1) {
                gameState.team1Score += 2;
            } else {
                gameState.team2Score += 2;
            }

            addGameLog(`${batterName} - HOME RUN! (2 points for Team ${gameState.currentTeam})`);
            resetStrikesAndTosses();
            gameState.selectedBatterIndex = null;
            updateUI();
        }

        // Hit to Base Functions
        function attemptHitBase1() {
            if (gameState.selectedBatterIndex === null) {
                alert('Please select a batter first!');
                openBatterModal();
                return;
            }

            const team = gameState.currentTeam === 1 ? 'team1' : 'team2';
            const batterName = rosters[team][gameState.selectedBatterIndex];
            addGameLog(`${batterName} - Hit to Base 1`);
            resetStrikesAndTosses();
            gameState.selectedBatterIndex = null;
            updateUI();
        }

        function attemptHitBase2() {
            if (gameState.selectedBatterIndex === null) {
                alert('Please select a batter first!');
                openBatterModal();
                return;
            }

            const team = gameState.currentTeam === 1 ? 'team1' : 'team2';
            const batterName = rosters[team][gameState.selectedBatterIndex];
            addGameLog(`${batterName} - Hit to Base 2`);
            resetStrikesAndTosses();
            gameState.selectedBatterIndex = null;
            updateUI();
        }

        // Pop Fly Catch Function
        function attemptPopFlyCatch() {
            if (gameState.selectedBatterIndex === null) {
                alert('Please select a batter first!');
                openBatterModal();
                return;
            }

            const team = gameState.currentTeam === 1 ? 'team1' : 'team2';
            const batterName = rosters[team][gameState.selectedBatterIndex];
            const fieldingTeam = gameState.currentTeam === 1 ? 2 : 1;

            if (fieldingTeam === 1) {
                gameState.team1Score += 1;
            } else {
                gameState.team2Score += 1;
            }

            gameState.outs++;
            addGameLog(`${batterName} - POP FLY CAUGHT! (1 point for Team ${fieldingTeam})`);

            if (gameState.outs >= 3) {
                gameState.outs = 0;
                switchInning();
            } else {
                resetStrikesAndTosses();
                gameState.selectedBatterIndex = null;
                updateUI();
            }
        }

        // Tagged Out Modal Functions
        function attemptTaggedOut() {
            if (gameState.selectedBatterIndex === null) {
                alert('Please select a batter first!');
                openBatterModal();
                return;
            }

            if (!document.getElementById('taggedOutModal').classList.contains('active')) {
                openTaggedOutModal();
            }
        }

        function openTaggedOutModal() {
            const team = gameState.currentTeam === 1 ? 'team1' : 'team2';
            const modalBody = document.getElementById('taggedOutModalBody');

            if (selectedTaggedOutPlayerIndex === null) {
                // Step 1: Select Player
                modalBody.innerHTML = '<div class="step-indicator">Step 1 of 2: Select the player who was tagged out</div><div class="player-selector" id="taggedOutPlayerSelector"></div>';

                const selector = document.getElementById('taggedOutPlayerSelector');
                rosters[team].forEach((player, index) => {
                    const option = document.createElement('div');
                    option.className = 'player-option';
                    option.textContent = player;
                    option.onclick = () => selectTaggedOutPlayerOption(index);
                    selector.appendChild(option);
                });
            } else {
                // Step 2: Select Base
                modalBody.innerHTML = '<div class="step-indicator">Step 2 of 2: Select the base where tagged out occurred</div><div class="player-selector" id="taggedOutBaseSelector"></div>';

                const selector = document.getElementById('taggedOutBaseSelector');
                const bases = ['Base 1', 'Base 2', 'Home'];
                bases.forEach((base, baseIndex) => {
                    const option = document.createElement('div');
                    option.className = `player-option ${selectedTaggedOutBase === baseIndex ? 'selected' : ''}`;
                    option.textContent = base;
                    option.onclick = () => selectTaggedOutBaseOption(baseIndex);
                    selector.appendChild(option);
                });
            }

            document.getElementById('taggedOutModal').classList.add('active');
            updateConfirmTaggedOutBtn();
        }

        function selectTaggedOutPlayerOption(index) {
            selectedTaggedOutPlayerIndex = index;
            document.querySelectorAll('#taggedOutPlayerSelector .player-option').forEach((el, i) => {
                el.classList.toggle('selected', i === index);
            });
            updateConfirmTaggedOutBtn();
        }

        function selectTaggedOutBaseOption(baseIndex) {
            selectedTaggedOutBase = baseIndex;
            document.querySelectorAll('#taggedOutBaseSelector .player-option').forEach((el, i) => {
                el.classList.toggle('selected', i === baseIndex);
            });
            updateConfirmTaggedOutBtn();
        }

        function confirmTaggedOut() {
            const team = gameState.currentTeam === 1 ? 'team1' : 'team2';

            if (selectedTaggedOutPlayerIndex === null) {
                openTaggedOutModal();
            } else if (selectedTaggedOutBase === null) {
                openTaggedOutModal();
            } else {
                const taggedOutPlayer = rosters[team][selectedTaggedOutPlayerIndex];
                const bases = ['Base 1', 'Base 2', 'Home'];
                const baseName = bases[selectedTaggedOutBase];
                const batterName = rosters[team][gameState.selectedBatterIndex];

                gameState.outs++;
                addGameLog(`${batterName} hit - ${taggedOutPlayer} tagged out at ${baseName}`);

                if (gameState.outs >= 3) {
                    gameState.outs = 0;
                    switchInning();
                } else {
                    resetStrikesAndTosses();
                    gameState.selectedBatterIndex = null;
                    updateUI();
                }

                closeTaggedOutModal();
            }
        }

        function closeTaggedOutModal() {
            document.getElementById('taggedOutModal').classList.remove('active');
            selectedTaggedOutPlayerIndex = null;
            selectedTaggedOutBase = null;
        }

        function updateConfirmTaggedOutBtn() {
            if (selectedTaggedOutPlayerIndex === null) {
                document.getElementById('confirmTaggedOutBtn').disabled = false;
                document.getElementById('confirmTaggedOutBtn').textContent = 'Next Step';
            } else if (selectedTaggedOutBase === null) {
                document.getElementById('confirmTaggedOutBtn').disabled = false;
                document.getElementById('confirmTaggedOutBtn').textContent = 'Confirm';
            } else {
                document.getElementById('confirmTaggedOutBtn').disabled = false;
                document.getElementById('confirmTaggedOutBtn').textContent = 'Confirm';
            }
        }

        // Inning Management
        function nextInning() {
            switchInning();
        }

        function switchInning() {
            gameState.outs = 0;
            resetStrikesAndTosses();
            gameState.selectedBatterIndex = null;

            if (gameState.inningPhase === 'Top') {
                gameState.inningPhase = 'Bottom';
                gameState.currentTeam = 2;
            } else {
                gameState.inningPhase = 'Top';
                gameState.inning++;
                gameState.currentTeam = 1;
            }

            renderRoster();
            addGameLog(`Inning ${gameState.inning} - ${gameState.inningPhase}`);
            updateUI();
        }

        // Switch Teams
        function switchTeams() {
            gameState.currentTeam = gameState.currentTeam === 1 ? 2 : 1;
            gameState.selectedBatterIndex = null;
            renderRoster();
            updateUI();
        }

        // Reset Game
        function resetGame() {
            if (confirm('Are you sure you want to reset the game?')) {
                gameState.inning = 1;
                gameState.inningPhase = 'Top';
                gameState.outs = 0;
                gameState.team1Score = 0;
                gameState.team2Score = 0;
                gameState.currentTeam = 1;
                gameState.selectedBatterIndex = null;
                gameState.tosses = 0;
                gameState.strikes = 0;
                gameState.gameLog = [];
                rosters.team1 = [];
                rosters.team2 = [];
                activeStatus.team1 = [];
                activeStatus.team2 = [];
                renderRoster();
                updateUI();
                document.getElementById('gameLog').innerHTML = '';
                pauseTimer();
                resetTimer();
            }
        }

        // Timer Functions
        function startTimer() {
            if (!gameState.timerRunning) {
                gameState.timerRunning = true;
                timerInterval = setInterval(() => {
                    gameState.timerSeconds++;
                    updateTimerDisplay();
                }, 1000);
            }
        }

        function pauseTimer() {
            gameState.timerRunning = false;
            clearInterval(timerInterval);
        }

        function resetTimer() {
            pauseTimer();
            gameState.timerSeconds = 0;
            updateTimerDisplay();
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(gameState.timerSeconds / 60);
            const seconds = gameState.timerSeconds % 60;
            document.getElementById('timerDisplay').textContent =
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        // Game Log
        function addGameLog(message, isAutoConversion = false) {
            const timestamp = new Date().toLocaleTimeString();
            gameState.gameLog.push({ message, timestamp, isAutoConversion });
            renderGameLog();
        }

        function renderGameLog() {
            const logElement = document.getElementById('gameLog');
            logElement.innerHTML = '';

            gameState.gameLog.forEach(entry => {
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry ${entry.isAutoConversion ? 'auto-conversion' : ''}`;
                logEntry.innerHTML = `
                    <div class="log-timestamp">${entry.timestamp}</div>
                    <div class="log-action">${entry.message}</div>
                `;
                logElement.appendChild(logEntry);
            });

            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearGameLog() {
            gameState.gameLog = [];
            renderGameLog();
        }

        // Export to CSV
        function exportGameDataCSV() {
            let csv = 'Stickball Game Report\n\n';
            csv += `Final Inning,${gameState.inning}\n`;
            csv += `Final Score - Team 1,${gameState.team1Score}\n`;
            csv += `Final Score - Team 2,${gameState.team2Score}\n\n`;

            csv += 'Team 1 Roster\n';
            rosters.team1.forEach(player => {
                csv += `${player}\n`;
            });

            csv += '\nTeam 2 Roster\n';
            rosters.team2.forEach(player => {
                csv += `${player}\n`;
            });

            csv += '\nGame Log\n';
            csv += 'Time,Action\n';
            gameState.gameLog.forEach(entry => {
                csv += `"${entry.timestamp}","${entry.message}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `stickball_game_${new Date().toISOString().slice(0, 10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Update UI
        function updateUI() {
            document.getElementById('inningNumber').textContent = gameState.inning;
            document.getElementById('inningPhase').textContent = gameState.inningPhase;
            document.getElementById('outsDisplay').textContent = gameState.outs;
            document.getElementById('team1Score').textContent = gameState.team1Score;
            document.getElementById('team2Score').textContent = gameState.team2Score;
            document.getElementById('activeTeamDisplay').textContent = `Team ${gameState.currentTeam}`;

            // Update current batter display
            const batterDisplay = document.getElementById('batterDisplay');
            if (gameState.selectedBatterIndex !== null) {
                const team = gameState.currentTeam === 1 ? 'team1' : 'team2';
                const batterName = rosters[team][gameState.selectedBatterIndex];
                document.getElementById('currentBatterName').textContent = batterName;
                batterDisplay.style.display = 'block';
            } else {
                batterDisplay.style.display = 'none';
            }

            // Update toss and strike counters display
            const countersContainer = document.getElementById('countersContainer');
            if (gameState.selectedBatterIndex !== null && (gameState.tosses > 0 || gameState.strikes > 0)) {
                document.getElementById('tossCounterValue').textContent = gameState.tosses;
                document.getElementById('strikeCounterValue').textContent = gameState.strikes;
                countersContainer.style.display = 'grid';
            } else {
                countersContainer.style.display = 'none';
            }
        }

        // Initialize App on Load
        window.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>


