<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stickball Scorekeeping App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding: 20px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .phase-hidden {
            display: none;
        }

        /* SETUP PHASE */
        .setup-container {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            max-width: 900px;
            margin: 0 auto;
        }

        .teams-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        @media (max-width: 768px) {
            .teams-grid {
                grid-template-columns: 1fr;
            }
        }

        .team-setup {
            border: 3px solid #667eea;
            border-radius: 10px;
            padding: 20px;
            background: #f9f9f9;
        }

        .team-setup h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
        }

        .players-container {
            margin-bottom: 20px;
        }

        .player-input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            align-items: center;
        }

        .player-input-group input {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 0.95em;
        }

        .player-input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-remove-player {
            background: #f44336;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 12px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: background 0.3s;
        }

        .btn-remove-player:hover {
            background: #d32f2f;
        }

        .btn-add-player {
            width: 100%;
            padding: 10px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 15px;
            transition: background 0.3s;
        }

        .btn-add-player:hover {
            background: #45a049;
        }

        .start-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .start-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .start-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* GAME PHASE */
        .game-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
        }

        .game-message {
            background: #e3f2fd;
            border-left: 5px solid #667eea;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-weight: 600;
            color: #1565c0;
            min-height: 30px;
        }

        .scoreboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .scoreboard {
                grid-template-columns: 1fr;
            }
        }

        .team-panel {
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
        }

        .team-panel.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.02);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .team-panel.inactive {
            background: #f5f5f5;
            border: 2px solid #ddd;
            color: #333;
        }

        .team-name {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .team-score {
            font-size: 3em;
            font-weight: bold;
            margin: 15px 0;
        }

        .players-list {
            text-align: left;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .player-item {
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 5px;
            font-size: 0.9em;
            background: rgba(0, 0, 0, 0.1);
        }

        .player-item.current-hitter {
            background: rgba(255, 255, 0, 0.3);
            font-weight: bold;
            border: 2px solid #ffd700;
        }

        .team-panel.inactive .player-item.current-hitter {
            background: rgba(255, 215, 0, 0.2);
        }

        .game-state {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }

        .state-box {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 2px solid #667eea;
        }

        .state-label {
            font-size: 0.85em;
            font-weight: bold;
            color: #667eea;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .state-value {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }

        .bases-display {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
        }

        .base {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            font-weight: bold;
        }

        .base.occupied {
            background: #4CAF50;
            color: white;
        }

        .base.empty {
            background: #ddd;
            color: #999;
        }

        .timer-box {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
            box-shadow: 0 5px 20px rgba(255, 107, 107, 0.3);
        }

        .timer-display {
            font-size: 3.5em;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            margin: 15px 0;
        }

        .timer-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .control-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin: 30px 0;
        }

        @media (max-width: 768px) {
            .control-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.2s;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-toss {
            background: #FFC107;
            color: #333;
        }

        .btn-strike {
            background: #f44336;
            color: white;
        }

        .btn-hit {
            background: #4CAF50;
            color: white;
        }

        .btn-home-run {
            background: #2196F3;
            color: white;
        }

        .btn-add-point {
            background: #00BCD4;
            color: white;
        }

        .btn-remove-point {
            background: #FF5722;
            color: white;
        }

        .btn-catch {
            background: #FF9800;
            color: white;
        }

        .btn-out {
            background: #9C27B0;
            color: white;
        }

        .btn-timer {
            background: #667eea;
            color: white;
        }

        .btn-export {
            background: #4CAF50;
            color: white;
            width: 100%;
            padding: 15px;
            font-size: 1em;
        }

        /* MODAL STYLES */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { 
                transform: translateY(-50px);
                opacity: 0;
            }
            to { 
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .player-selector {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .player-option {
            padding: 12px;
            background: #f5f5f5;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .player-option:hover {
            background: #e3f2fd;
            border-color: #667eea;
        }

        .player-option.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .modal-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .btn-confirm {
            background: #4CAF50;
            color: white;
            padding: 12px;
            font-size: 1em;
        }

        .btn-confirm:hover {
            background: #45a049;
        }

        .btn-cancel {
            background: #f44336;
            color: white;
            padding: 12px;
            font-size: 1em;
        }

        .btn-cancel:hover {
            background: #d32f2f;
        }

        /* GAME LOG */
        .game-log {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
        }

        .game-log h3 {
            margin-bottom: 15px;
            color: #667eea;
            font-size: 1.3em;
        }

        .log-entries {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 0.9em;
        }

        .log-entry {
            padding: 10px;
            border-bottom: 1px solid #eee;
            color: #555;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-timestamp {
            color: #667eea;
            font-weight: bold;
            margin-right: 10px;
        }

        .log-action {
            color: #333;
        }

        /* COMPLETION PHASE */
        .completion-container {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            margin: 0 auto;
            text-align: center;
        }

        .completion-container h2 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 30px;
        }

        .final-scores {
            margin: 30px 0;
        }

        .final-score-item {
            font-size: 1.3em;
            margin: 15px 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
        }

        .final-score-item .team-name {
            color: #667eea;
            font-weight: bold;
        }

        .final-score-item .score-value {
            font-size: 2em;
            color: #333;
            margin-top: 10px;
        }

        .completion-buttons {
            display: grid;
            gap: 15px;
            margin-top: 30px;
        }

        .btn-new-game {
            background: #667eea;
            color: white;
            padding: 15px;
            font-size: 1em;
        }

        .btn-new-game:hover {
            background: #764ba2;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }

        .empty-log {
            text-align: center;
            color: #999;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üèè Stickball Scorekeeping</h1>
        <p>Track your game with precision</p>
    </div>

    <div class="container">
        <!-- SETUP PHASE -->
        <div id="setupPhase" class="setup-container">
            <h2 style="text-align: center; color: #667eea; margin-bottom: 30px;">Setup Your Game</h2>
            
            <div class="teams-grid">
                <div class="team-setup">
                    <h2>Team 1</h2>
                    <div class="form-group">
                        <label>Team Name</label>
                        <input type="text" id="team1Name" placeholder="Enter team name">
                    </div>
                    <div class="players-container">
                        <label style="display: block; font-weight: 600; color: #333; margin-bottom: 10px;">Players</label>
                        <div id="team1PlayersInputs"></div>
                        <button class="btn-add-player" onclick="addPlayerField(1)">+ Add Player</button>
                    </div>
                </div>

                <div class="team-setup">
                    <h2>Team 2</h2>
                    <div class="form-group">
                        <label>Team Name</label>
                        <input type="text" id="team2Name" placeholder="Enter team name">
                    </div>
                    <div class="players-container">
                        <label style="display: block; font-weight: 600; color: #333; margin-bottom: 10px;">Players</label>
                        <div id="team2PlayersInputs"></div>
                        <button class="btn-add-player" onclick="addPlayerField(2)">+ Add Player</button>
                    </div>
                </div>
            </div>

            <button class="start-button" onclick="startGame()">Start Game</button>
        </div>

        <!-- GAME PHASE -->
        <div id="gamePhase" class="phase-hidden">
            <div class="game-container">
                <div class="game-message" id="gameMessage">Game started! Let's play!</div>

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                    <h2 id="pageTitle" style="color: #667eea; margin: 0;">Game in Progress</h2>
                    <button class="btn-export" onclick="exportToCSV()">üì• Export to CSV</button>
                </div>

                <div class="scoreboard">
                    <div id="team1Panel" class="team-panel active">
                        <div class="team-name" id="team1DisplayName">Team 1</div>
                        <div class="team-score" id="team1Score">0</div>
                        <div class="players-list" id="team1PlayersList"></div>
                    </div>
                    <div id="team2Panel" class="team-panel inactive">
                        <div class="team-name" id="team2DisplayName">Team 2</div>
                        <div class="team-score" id="team2Score">0</div>
                        <div class="players-list" id="team2PlayersList"></div>
                    </div>
                </div>

                <div class="timer-box">
                    <div style="font-size: 1em; font-weight: bold; margin-bottom: 10px;">‚è±Ô∏è GAME TIMER</div>
                    <div class="timer-display" id="timerDisplay">40:00</div>
                    <div class="timer-controls">
                        <button class="btn-timer" onclick="toggleTimer()">‚ñ∂Ô∏è Play / ‚è∏Ô∏è Pause</button>
                        <button class="btn-timer" onclick="resetTimer()">‚Üª Reset</button>
                    </div>
                </div>

                <div class="game-state">
                    <div class="state-box">
                        <div class="state-label">Inning</div>
                        <div class="state-value" id="inningDisplay">1</div>
                        <div style="font-size: 0.8em; margin-top: 5px;" id="halfDisplay">Top</div>
                    </div>
                    <div class="state-box">
                        <div class="state-label">Current Hitter</div>
                        <div class="state-value" id="currentHitterDisplay" style="font-size: 1.2em;">-</div>
                    </div>
                    <div class="state-box">
                        <div class="state-label">Tosses</div>
                        <div class="state-value" id="tossesDisplay">0/4</div>
                    </div>
                    <div class="state-box">
                        <div class="state-label">Strikes</div>
                        <div class="state-value" id="strikesDisplay">0/3</div>
                    </div>
                    <div class="state-box">
                        <div class="state-label">Outs</div>
                        <div class="state-value" id="outsDisplay">0/3</div>
                    </div>
                    <div class="state-box">
                        <div class="state-label">Bases</div>
                        <div class="bases-display">
                            <div class="base empty" id="base1">1</div>
                            <div class="base empty" id="base2">2</div>
                        </div>
                    </div>
                </div>

                <div class="control-buttons">
                    <button class="btn-toss" id="tossButton" onclick="recordToss()">Toss (0/4)</button>
                    <button class="btn-strike" onclick="recordStrike('Swing/Miss')">Strike (Swing)</button>
                    <button class="btn-strike" onclick="recordStrike('Foul Ball')">Strike (Foul)</button>
                    <button class="btn-hit" onclick="recordHit(1)">Hit to Base 1</button>
                    <button class="btn-hit" onclick="recordHit(2)">Hit to Base 2</button>
                    <button class="btn-home-run" onclick="recordHomeRun()">üè† Home Run</button>
                    <button class="btn-add-point" onclick="openScorerModal()">‚ûï Add Point</button>
                    <button class="btn-remove-point" onclick="removePoint()">‚ûñ Remove Point</button>
                    <button class="btn-tagged-out" onclick="recordTaggedOut(1)">Tagged Out Base 1</button>
                    <button class="btn-tagged-out" onclick="recordTaggedOut(2)">Tagged Out Base 2</button>
                    <button class="btn-catch" onclick="recordPopFlyCatch()">Pop Fly Catch</button>
                    <button class="btn-out" onclick="recordOut('Other')">Other Out</button>
                </div>
            </div>

            <!-- SCORER MODAL -->
            <div id="scorerModal" class="modal">
                <div class="modal-content">
                    <h2>Who Scored?</h2>
                    <div class="player-selector" id="playerSelector"></div>
                    <div class="modal-buttons">
                        <button class="btn-confirm" onclick="confirmScorer()">‚úì Confirm</button>
                        <button class="btn-cancel" onclick="closeScorerModal()">‚úï Cancel</button>
                    </div>
                </div>
            </div>

            <div class="game-log">
                <h3>üìã Game Log</h3>
                <div class="log-entries" id="logEntries">
                    <div class="empty-log">No events yet</div>
                </div>
            </div>
        </div>

        <!-- COMPLETION PHASE -->
        <div id="completionPhase" class="phase-hidden">
            <div class="completion-container">
                <h2>üéâ Game Over!</h2>
                <div class="final-scores" id="finalScoresDisplay"></div>
                <div class="completion-buttons">
                    <button class="btn-export" onclick="exportToCSV()">üì• Export Game Data</button>
                    <button class="btn-new-game" onclick="resetGame()">Start New Game</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Game State
        let gameState = {
            phase: 'setup',
            teams: [
                { name: '', players: [], currentHitterIndex: 0, score: 0 },
                { name: '', players: [], currentHitterIndex: 0, score: 0 }
            ],
            currentInning: 1,
            isTopHalf: true,
            tosses: 0,
            strikes: 0,
            outs: 0,
            bases: { base1: false, base2: false },
            timerSeconds: 2400,
            timerActive: false,
            timerInterval: null,
            gameLog: [],
            gameMessage: "Game started! Let's play!",
            selectedScorerIndex: null
        };

        // Initialize Setup Phase
        function initializeSetup() {
            for (let teamId = 1; teamId <= 2; teamId++) {
                gameState.teams[teamId - 1].players = ['', '', '', ''];
                renderPlayerInputs(teamId);
            }
        }

        // Render player input fields
        function renderPlayerInputs(teamId) {
            const container = document.getElementById(`team${teamId}PlayersInputs`);
            const players = gameState.teams[teamId - 1].players;
            
            container.innerHTML = players.map((player, idx) => `
                <div class="player-input-group">
                    <input type="text" value="${player}" placeholder="Player ${idx + 1}" 
                           onchange="updatePlayerName(${teamId - 1}, ${idx}, this.value)">
                    <button class="btn-remove-player" onclick="removePlayer(${teamId - 1}, ${idx})">‚úï</button>
                </div>
            `).join('');
        }

        // Add a new player field
        function addPlayerField(teamId) {
            gameState.teams[teamId - 1].players.push('');
            renderPlayerInputs(teamId);
        }

        // Remove a player field
        function removePlayer(teamIndex, playerIndex) {
            gameState.teams[teamIndex].players.splice(playerIndex, 1);
            renderPlayerInputs(teamIndex + 1);
        }

        // Update player name
        function updatePlayerName(teamIndex, playerIndex, name) {
            gameState.teams[teamIndex].players[playerIndex] = name;
        }

        // Start Game
        function startGame() {
            gameState.teams[0].name = document.getElementById('team1Name').value.trim();
            gameState.teams[1].name = document.getElementById('team2Name').value.trim();

            if (!gameState.teams[0].name || !gameState.teams[1].name) {
                alert('Please fill in team names');
                return;
            }

            if (gameState.teams[0].players.some(p => !p) || gameState.teams[1].players.some(p => !p)) {
                alert('Please fill in all player names or remove empty fields');
                return;
            }

            if (gameState.teams[0].players.length === 0 || gameState.teams[1].players.length === 0) {
                alert('Each team must have at least one player');
                return;
            }

            gameState.phase = 'game';
            gameState.gameLog = [];
            addToLog('Game started');
            updateDisplay();
            showPhase('game');
        }

        // Record Toss
        function recordToss() {
            if (gameState.tosses >= 4) return;

            gameState.tosses++;
            updateDisplay();
            addToLog(`Toss ${gameState.tosses} to ${getCurrentHitter()}`);

            if (gameState.tosses === 4) {
                setGameMessage(`4th toss! Next action: hit or strike.`);
                document.getElementById('tossButton').disabled = true;
            }
        }

        // Record Strike
        function recordStrike(type) {
            gameState.strikes++;
            gameState.tosses = 0;
            addToLog(`Strike ${gameState.strikes} (${type}) - ${getCurrentHitter()}`);

            if (gameState.strikes === 3) {
                recordOut('Struck Out');
            } else {
                setGameMessage(`${getCurrentHitter()} - Strike ${gameState.strikes}/3`);
                updateDisplay();
            }
        }

        // Record Hit (NO automatic scoring)
        function recordHit(baseReached) {
            const hitter = getCurrentHitter();
            addToLog(`${hitter} hit to base ${baseReached}`);

            // Place runner on the base they hit to
            if (baseReached === 1) {
                gameState.bases.base1 = true;
            } else if (baseReached === 2) {
                // If runner on base 1, they move to base 2
                if (gameState.bases.base1) {
                    gameState.bases.base2 = true;
                }
                gameState.bases.base1 = false;
            }

            gameState.tosses = 0;
            gameState.strikes = 0;
            advanceHitter();
            setGameMessage(`${hitter} hit to base ${baseReached}`);
            updateDisplay();
        }

        // Record Home Run (NO automatic scoring of runners)
        function recordHomeRun() {
            const hitter = getCurrentHitter();
            gameState.teams[getCurrentTeamIndex()].score += 2;
            addToLog(`${hitter} HOME RUN! (+2 points)`);

            // Clear bases - user will manually score runners if they made it home
            gameState.bases = { base1: false, base2: false };
            gameState.tosses = 0;
            gameState.strikes = 0;
            advanceHitter();
            setGameMessage(`üè† ${hitter} HOME RUN! (+2 points). Manually score any runners who made it home.`);
            updateDisplay();
        }

        // Open Scorer Modal
        function openScorerModal() {
            const teamIndex = getCurrentTeamIndex();
            const team = gameState.teams[teamIndex];
            const selector = document.getElementById('playerSelector');

            selector.innerHTML = team.players.map((player, idx) => `
                <div class="player-option" onclick="selectScorer(${idx})" id="player-${idx}">
                    ${player}
                </div>
            `).join('');

            gameState.selectedScorerIndex = null;
            document.getElementById('scorerModal').classList.add('show');
        }

        // Select Scorer
        function selectScorer(playerIndex) {
            // Remove previous selection
            document.querySelectorAll('.player-option').forEach(el => {
                el.classList.remove('selected');
            });

            // Add selection to clicked player
            document.getElementById(`player-${playerIndex}`).classList.add('selected');
            gameState.selectedScorerIndex = playerIndex;
        }

        // Confirm Scorer
        function confirmScorer() {
            if (gameState.selectedScorerIndex === null) {
                alert('Please select a player');
                return;
            }

            const teamIndex = getCurrentTeamIndex();
            const scoringPlayer = gameState.teams[teamIndex].players[gameState.selectedScorerIndex];
            
            gameState.teams[teamIndex].score += 1;
            addToLog(`${scoringPlayer} scored! +1 point`);
            setGameMessage(`‚úì ${scoringPlayer} scored! +1 point`);
            
            closeScorerModal();
            updateDisplay();
        }

        // Close Scorer Modal
        function closeScorerModal() {
            document.getElementById('scorerModal').classList.remove('show');
            gameState.selectedScorerIndex = null;
        }

        // Remove Point
        function removePoint() {
            const teamIndex = getCurrentTeamIndex();
            if (gameState.teams[teamIndex].score <= 0) {
                setGameMessage('Cannot remove point - score is already 0');
                return;
            }

            gameState.teams[teamIndex].score -= 1;
            addToLog(`Point removed (error correction). -1 point`);
            setGameMessage(`‚ùå Point removed (error correction). Current score: ${gameState.teams[teamIndex].score}`);
            updateDisplay();
        }

        // Record Tagged Out
        function recordTaggedOut(baseNumber) {
            if (baseNumber === 1 && !gameState.bases.base1) {
                setGameMessage('No runner on base 1');
                return;
            }
            if (baseNumber === 2 && !gameState.bases.base2) {
                setGameMessage('No runner on base 2');
                return;
            }

            gameState.outs++;
            addToLog(`Runner tagged out at base ${baseNumber}`);

            // Remove the runner from the base
            if (baseNumber === 1) {
                gameState.bases.base1 = false;
            } else if (baseNumber === 2) {
                gameState.bases.base2 = false;
            }

            if (gameState.outs === 3) {
                endInning();
            } else {
                setGameMessage(`Out ${gameState.outs}/3 - Runner tagged out at base ${baseNumber}`);
                updateDisplay();
            }
        }

        // Record Pop Fly Catch
        function recordPopFlyCatch() {
            const hitter = getCurrentHitter();
            const fieldingTeamIndex = getCurrentTeamIndex() === 0 ? 1 : 0;
            gameState.teams[fieldingTeamIndex].score++;
            addToLog(`${hitter} caught on pop fly. Fielding team +1 point`);
            setGameMessage(`Pop fly caught! ${gameState.teams[fieldingTeamIndex].name} +1 point`);
            recordOut('Pop Fly Caught');
        }

        // Record Out
        function recordOut(type) {
            gameState.outs++;
            const hitter = getCurrentHitter();
            addToLog(`Out ${gameState.outs}: ${hitter} (${type})`);

            gameState.bases = { base1: false, base2: false };
            gameState.tosses = 0;
            gameState.strikes = 0;

            if (gameState.outs === 3) {
                endInning();
            } else {
                advanceHitter();
                setGameMessage(`Out ${gameState.outs}/3 - Next hitter`);
                updateDisplay();
            }
        }

        // End Inning
        function endInning() {
            if (gameState.isTopHalf) {
                gameState.isTopHalf = false;
                setGameMessage(`End of top inning ${gameState.currentInning}. Bottom inning starting.`);
                addToLog(`End of top inning ${gameState.currentInning}`);
            } else {
                if (gameState.currentInning === 2) {
                    gameState.phase = 'completion';
                    showPhase('completion');
                    displayFinalScores();
                    clearInterval(gameState.timerInterval);
                    gameState.timerActive = false;
                    return;
                } else {
                    gameState.currentInning = 2;
                    gameState.isTopHalf = true;
                    setGameMessage(`End of inning 1. Inning 2 starting.`);
                    addToLog(`End of inning 1`);
                }
            }

            gameState.outs = 0;
            gameState.tosses = 0;
            gameState.strikes = 0;
            gameState.bases = { base1: false, base2: false };
            updateDisplay();
        }

        // Advance Hitter
        function advanceHitter() {
            const teamIndex = getCurrentTeamIndex();
            const numPlayers = gameState.teams[teamIndex].players.length;
            gameState.teams[teamIndex].currentHitterIndex = 
                (gameState.teams[teamIndex].currentHitterIndex + 1) % numPlayers;
        }

        // Timer Functions
        function toggleTimer() {
            gameState.timerActive = !gameState.timerActive;

            if (gameState.timerActive) {
                gameState.timerInterval = setInterval(() => {
                    gameState.timerSeconds--;
                    document.getElementById('timerDisplay').textContent = formatTime(gameState.timerSeconds);

                    if (gameState.timerSeconds === 0) {
                        clearInterval(gameState.timerInterval);
                        gameState.timerActive = false;
                        setGameMessage('‚è∞ Game Time Expired!');
                        gameState.phase = 'completion';
                        showPhase('completion');
                        displayFinalScores();
                    }
                }, 1000);
            } else {
                clearInterval(gameState.timerInterval);
            }
        }

        function resetTimer() {
            clearInterval(gameState.timerInterval);
            gameState.timerActive = false;
            gameState.timerSeconds = 2400;
            updateDisplay();
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }

        // Utility Functions
        function getCurrentTeamIndex() {
            return gameState.isTopHalf ? 0 : 1;
        }

        function getCurrentHitter() {
            const teamIndex = getCurrentTeamIndex();
            return gameState.teams[teamIndex].players[gameState.teams[teamIndex].currentHitterIndex];
        }

        function setGameMessage(message) {
            gameState.gameMessage = message;
            document.getElementById('gameMessage').textContent = message;
        }

        function addToLog(action) {
            const timestamp = new Date().toLocaleTimeString();
            gameState.gameLog.push({ timestamp, action });
            updateLogDisplay();
        }

        function updateLogDisplay() {
            const logEntries = document.getElementById('logEntries');
            if (gameState.gameLog.length === 0) {
                logEntries.innerHTML = '<div class="empty-log">No events yet</div>';
                return;
            }

            logEntries.innerHTML = gameState.gameLog.map(entry => 
                `<div class="log-entry">
                    <span class="log-timestamp">${entry.timestamp}</span>
                    <span class="log-action">${entry.action}</span>
                </div>`
            ).join('');

            logEntries.scrollTop = logEntries.scrollHeight;
        }

        // Display Functions
        function updateDisplay() {
            updateTeamPanel(0);
            updateTeamPanel(1);

            document.getElementById('inningDisplay').textContent = gameState.currentInning;
            document.getElementById('halfDisplay').textContent = gameState.isTopHalf ? 'Top' : 'Bottom';
            document.getElementById('currentHitterDisplay').textContent = getCurrentHitter();
            document.getElementById('tossesDisplay').textContent = `${gameState.tosses}/4`;
            document.getElementById('strikesDisplay').textContent = `${gameState.strikes}/3`;
            document.getElementById('outsDisplay').textContent = `${gameState.outs}/3`;
            document.getElementById('timerDisplay').textContent = formatTime(gameState.timerSeconds);

            document.getElementById('base1').className = gameState.bases.base1 ? 'base occupied' : 'base empty';
            document.getElementById('base2').className = gameState.bases.base2 ? 'base occupied' : 'base empty';

            const tossButton = document.getElementById('tossButton');
            tossButton.textContent = `Toss (${gameState.tosses}/4)`;
            tossButton.disabled = gameState.tosses >= 4;
        }

        function updateTeamPanel(teamIndex) {
            const team = gameState.teams[teamIndex];
            const panelId = `team${teamIndex + 1}Panel`;
            const panel = document.getElementById(panelId);

            const isActive = (gameState.isTopHalf && teamIndex === 0) || (!gameState.isTopHalf && teamIndex === 1);
            panel.className = `team-panel ${isActive ? 'active' : 'inactive'}`;

            document.getElementById(`team${teamIndex + 1}Score`).textContent = team.score;

            const playersList = document.getElementById(`team${teamIndex + 1}PlayersList`);
            playersList.innerHTML = team.players.map((player, idx) => 
                `<div class="player-item ${idx === team.currentHitterIndex && isActive ? 'current-hitter' : ''}">
                    ${player}
                </div>`
            ).join('');
        }

        function displayFinalScores() {
            const display = document.getElementById('finalScoresDisplay');
            display.innerHTML = gameState.teams.map((team, idx) => 
                `<div class="final-score-item">
                    <div class="team-name">${team.name || `Team ${idx + 1}`}</div>
                    <div class="score-value">${team.score}</div>
                </div>`
            ).join('');
        }

        function showPhase(phase) {
            document.getElementById('setupPhase').classList.toggle('phase-hidden', phase !== 'setup');
            document.getElementById('gamePhase').classList.toggle('phase-hidden', phase !== 'game');
            document.getElementById('completionPhase').classList.toggle('phase-hidden', phase !== 'completion');
        }

        // CSV Export
        function exportToCSV() {
            const team1 = gameState.teams[0];
            const team2 = gameState.teams[1];

            let csv = 'Stickball Game Report\n';
            csv += `Date: ${new Date().toLocaleString()}\n\n`;
            csv += `Team 1: ${team1.name}\n`;
            csv += `Players: ${team1.players.join(', ')}\n`;
            csv += `Final Score: ${team1.score}\n\n`;
            csv += `Team 2: ${team2.name}\n`;
            csv += `Players: ${team2.players.join(', ')}\n`;
            csv += `Final Score: ${team2.score}\n\n`;
            csv += 'Game Log\n';
            csv += 'Timestamp,Action\n';

            gameState.gameLog.forEach(entry => {
                csv += `"${entry.timestamp}","${entry.action}"\n`;
            });

            downloadCSV(csv, `stickball_game_${new Date().getTime()}.csv`);
        }

        function downloadCSV(csv, filename) {
            const link = document.createElement('a');
            link.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Reset Game
        function resetGame() {
            gameState = {
                phase: 'setup',
                teams: [
                    { name: '', players: [], currentHitterIndex: 0, score: 0 },
                    { name: '', players: [], currentHitterIndex: 0, score: 0 }
                ],
                currentInning: 1,
                isTopHalf: true,
                tosses: 0,
                strikes: 0,
                outs: 0,
                bases: { base1: false, base2: false },
                timerSeconds: 2400,
                timerActive: false,
                timerInterval: null,
                gameLog: [],
                gameMessage: "Game started! Let's play!",
                selectedScorerIndex: null
            };

            document.getElementById('team1Name').value = '';
            document.getElementById('team2Name').value = '';

            clearInterval(gameState.timerInterval);
            showPhase('setup');
            initializeSetup();
        }

        // Close modal when clicking outside
        window.addEventListener('click', (event) => {
            const modal = document.getElementById('scorerModal');
            if (event.target === modal) {
                closeScorerModal();
            }
        });

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            initializeSetup();
            showPhase('setup');
        });
    </script>
</body>
</html>
